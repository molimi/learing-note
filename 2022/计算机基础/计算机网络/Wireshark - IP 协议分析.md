IP 协议（Internet Protocol），又译为网际协议或互联网协议，是用在 TCP/IP 协议簇中的网络层协议。主要功能是无连接数据报传送、数据报路由选择和差错控制。
IP 协议是 TCP/IP 协议族的核心协议，其主要包含两个方面：

1. IP 头部信息。IP 头部信息出现在每个 IP 数据报中，用于指定 IP 通信的源端 IP 地址、目的端 IP 地址，指导 IP 分片和重组，以及指定部分通信行为； IP 协议分为 IPv4 版本和 IPv6 版本。

2. IP数据报的路由和转发。IP数据报的路由和转发发生在除目标机器之外的所有主机和路由器上。它们决定数据报是否应该转发以及如何转发；


IP 的主要目的是通过一个互联的网络传输数据报，涉及两个最基本的功能：
- 寻址( Addressing )：IP 协议根据数据报首部中包括的目的地址将数据报传送到目的节点，这就要涉及传送路径的选择，即路由功能。IP 协议使用 IP 地址来实现路由；
- 分片( Fragmentation )：IP 协议还提供对数据大小的分片和重组，以适应不同网络对数据包大小的限制。如果网络只能传送小数据包，IP 协议将对数据报进行分段并重新组成小块再进行传送。


要注意的是：IP 协议提供尽最大努力投递( Best-effort Delivery )的传输服务，是不可靠无连接的数据报服务。源主机只是简单地将 IP 数据报发送出去，数据报传输路由可以完全不同，数据报抵达的先后顺序也不确定。不可靠性则是指数据报在传输过程中可能会出现丢失、重复、延迟时间大或者次序混乱等现象，但 IP 协议并不进行检查，不回送确认，也没有流量控制和差错控制功能。如果数据报在传输中发生某种错误，如某个路由器暂时用完了缓冲区，IP 有一个简单的错误处理算法：丢弃该数据报，然后发送 ICMP 消息报给信源端。因此，要实现数据报的可靠传输，就必须依靠高层的协议或应用程序，如传输层的 TCP 协议。


## 1 IP协议分析
### 1.1 IP数据包

**IPV4数据包**

网际协议第 4 版（Internet Protocol version 4，IPv4）是 TCP/IP 协议使用的数据报传输机制。数据报是一个可变长分组，由两部分组成：头部和数据。头部长度可由 20~60 个字节组成，该部分包含有与路由选择和传输有关的重要信息。头部各字段意义按顺序如下：

<img src ="https://img-blog.csdnimg.cn/49bda0b166474a098cf179b92fc06bca.png#pic_center" width = 48%>

(1) 版本（ 4 位）：该字段定义 IP 协议版本，负责向处理机所运行的 IP 软件指明此 IP 数据报是哪个版本，所有字段都要按照此版本的协议来解释。如果计算机使用其他版本，则丢弃数据报；
(2) 头部长度（ 4 位）：该字段定义数据报协议头长度，表示协议头部具有 32 位字长的数量。协议头最小值为 5 ，最大值为 15；
(3) 服务（ 8 位）：该字段定义上层协议对处理当前数据报所期望的服务质量，并对数据报按照重要性级别进行分配。前 3 位成为优先位，后面 4 位成为服务类型，最后 1 位没有定义。这些 8 位字段用于分配优先级、延迟、吞吐量以及可靠性；
(4) 总长度（ 16 位）：该字段定义整个 IP 数据报的字节长度，包括协议头部和数据。其最大值为 65535 字节。以太网协议对能够封装在一个帧中的数据有最小值和最大值的限制（ 46~1500 个字节）；
(5) 标识（ 16 位）：该字段包含一个整数，用于识别当前数据报。当数据报分段时，标识字段的值被复制到所有的分段之中。该字段由发送端分配，帮助接收端集中数据报分段；
(6) 标记（ 3 位）：该字段由 3 位字段构成，其中最低位（ MF ）控制分段，存在下一个分段置为 1 ，否则置 0 代表该分段是最后一个分段。中间位（ DF ）指出数据报是否可进行分段，如果为 1 则机器不能将该数据报进行分段。第三位即最高位保留不使用，值为 0；
(7) 分段偏移（ 13 位）：该字段指出分段数据在源数据报中的相对位置，支持目标 IP 适当重建源数据；
(8) 生存时间（ 8 位）：该字段是一种计数器，在丢弃数据报的每个点值依次减 1 直至减少为 0 。这样确保数据报拥有有限的环路过程（即 TTL ），限制了数据报的寿命；
(9) 协议（ 8 位）：该字段指出在 IP 处理过程完成之后，有哪种上层协议接收导入数据报。这个字段的值对接收方的网络层了解数据属于哪个协议很有帮助；

常见的协议值有：
<table>
<thead>
<tr>
<th>协议字段值</th>
<th>协议名</th>
<th>缩写</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>互联网消息控制协议</td>
<td>ICMP</td>
</tr>
<tr>
<td>2</td>
<td>互联网组管理协议</td>
<td>IGMP</td>
</tr>
<tr>
<td>6</td>
<td>传输控制协议</td>
<td>TCP</td>
</tr>
<tr>
<td>17</td>
<td>用户数据报协议</td>
<td>UDP</td>
</tr>
<tr>
<td>41</td>
<td>IPv6 封装</td>
<td>ENCAP</td>
</tr>
<tr>
<td>89</td>
<td>开放式最短路径优先</td>
<td>OSPF</td>
</tr>
<tr>
<td>132</td>
<td>流控制传输协议</td>
<td>SCTP</td>
</tr>
</tbody>
</table>

(10) 头部校验和（ 16 位）：该字段帮助确保 IP 协议头的完整性。由于某些协议头字段的改变，这就需要对每个点重新计算和检验。计算过程是先将校验和字段置为 0 ，然后将整个头部每 16 位划分为一部分，将个部分相加，再将计算结果取反码，插入到校验和字段中；校验和的运算方式是采用反码算术运算求和，和的反码作为该字段的值，可以参考下面的例子：

<img src ="https://img-blog.csdnimg.cn/ce4e8ba8095b4572818f9c89dd7bb3e0.png#pic_center" width = 48%>

(11) 源地址（ 32 位）：源主机 IP 地址，该字段在 IPv4 数据报从源主机到目的主机传输期间必须保持不变；
(12) 目的地址（ 32 位）：目标主机 IP 地址，该字段在 IPv4 数据报从源主机到目的主机传输期间同样必须保持不变。


**IPv6数据包**

在 2011 年 2 月，IANA 向一个区域注册机构分配完了未分配的 IPv4 地址的最后剩余地址池。这些注册机构可用的 IPv4 地址一旦用完，IPv4 地址就会耗尽，因此IPv6 技术就被开始进行研发部署。(原计划让 ST-2 作为 IPv5，但是 ST-2 后来就被舍弃了。)下面就让我们看看 IPv6 数据报有什么内容：

<img src ="https://img-blog.csdnimg.cn/e83f97ba2651448d97827835972c0910.png#pic_center" width = 48%>

### 1.2 数据包分片

对于链路层协议，不同的链路层协议能承载的网络层分组长度并不同，一个链路层协议能承载的最大数据量称之为最大传输单元 (MTU)。若传输时经过很多路由器，而之间的每条链路的 MTU 不同怎么办？解决方法就是将 IP 数据报中的数据分片为多个 IP 数据报，然后用单独的链路层帧封装数据报并发送。大 IP 数据分组向较小 MTU 链路转发时，在允许的情况下可以进行分片。
分片时每个分片的标识复制原 IP 分组标识，通常除了最后一个分组，其他分片均分为 MTU 允许的最大分片。一个最大分片可封装的数据，应该为 8 的倍数。既然有分片，那就需要重组为完整的数据报，IP 分片的重组工作由目的端系统负责。



### 1.3 IPv4 编址
#### 1.3.1 IP 地址的表示

主机与物理链路、路由器与其任意一条链路之间的边界，都被称之为接口。由于每个主机和路由器都可以发送和接受 IP 数据报，因此所有接口都得拥有自己的 IP 地址。问题是如果 IP 地址乱分配，会使得转发表变得异常复杂，应该怎么样为接口分配 IP 地址？


IP 地址由 2 个字段组成，分别是网络前缀和主机号。网络前缀用于指明主机或路由器所连接到的网络，网络前缀在互联网中必须是唯一的。主机号用于标志主机或路由器，主机号在其所在的网络中是唯一的。就像电话号码划分区号一样，只有通过网络号和主机号的标识，路由器才能知道如何转发，而一个 IP 地址在互联网中是唯一的。



