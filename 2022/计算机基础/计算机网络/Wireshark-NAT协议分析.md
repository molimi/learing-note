NAT（Network Address Translation）网络地址转换，即在私有地址和全局地址之间转换的协议。私有地址是不能用在 Internet 上(路由器将丢弃寻址这种地址的包)的内部地址。这些地址是不能够在公网上面用的，只能用在局域网的内部。私有地址有三种：①`10.0.0.0~10.255.255.255/8`；② `172.16.0.0~172.31.255.255/12`； ③ `192.168.0.0~192.168.255.255/16`。这些 IP 地址是用于私有的网络，与之对应的是全局地址，就是正规的自己电脑的地址，全网络承认。

NAT 协议的工作过程如下所示：

<img src ="https://img-blog.csdnimg.cn/4f63555f2c5c48e8bdcd546c1188bc70.png#pic_center" width = 64%>


假设一个私有地址为 `10.1.0.2` 的主机想访问互联网服务器 `162.105.192.12`，那么首先它首先把消息发出给 NAT 路由器。路由器记录了它的内网地址和端口，并且给它分配一个全局地址和全局端口。这个地址关系记录在 NAT 路由表中。之后按照目的地址发给服务器。一段时间之后，服务器回应了请求给 NAT 路由器，那么路由器根据目的地址和端口（此时是全局的）按照 NAT 路由表转换为对应的主机地址，再发送给主机，这样主机就收到了服务器的回应。

从上面的过程就能看到 NAT 路由器的作用：针对出境包源地址进行替换；在 NAT 转换表中记录映射关系；针对入境包目标地址进行替换。

NAT 的路由表如下所示：

<img src ="https://img-blog.csdnimg.cn/21a4c78d7e7d4cca891640a5f87df747.png#pic_center" width = 64%>


**功能**

NAT 不仅能解决 IP 地址不足的问题，而且还能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机。作用是把内网的私有地址，转化成外网的公有地址。使得内部网络上的（被设置为私有 IP 地址的）主机可以访问 Internet。
1. 宽带分享：这是 NAT 主机的最大功能。
2. 安全防护：NAT 之内的 PC 联机到 Internet 上面时，他所显示的 IP 是 NAT 主机的公共 IP，所以 Client 端的 PC 当然就具有一定程度的安全了，外界在进行 portscan（端口扫描） 的时候，就侦测不到源 Client 端的 PC 。

**实现方式**

NAT 的实现方式有三种，即静态转换 Static Nat、动态转换 Dynamic Nat 和端口多路复用 OverLoad。
1. 静态转换是指将内部网络的私有 IP 地址转换为公有 IP 地址，IP地址对是一对一的，是一成不变的，某个私有IP地址只转换为某个公有IP地址。借助于静态转换，可以实现外部网络对内部网络中某些特定设备（如服务器）的访问。
2. 动态转换是指将内部网络的私有 IP 地址转换为公用 IP 地址时，IP 地址是不确定的，是随机的，所有被授权访问上 Internet 的私有 IP 地址可随机转换为任何指定的合法 IP 地址。也就是说，只要指定哪些内部地址可以进行转换，以及用哪些合法地址作为外部地址时，就可以进行动态转换。动态转换可以使用多个合法外部地址集。当 ISP 提供的合法 IP 地址略少于网络内部的计算机数量时。可以采用动态转换的方式。
3. 端口多路复用是指改变外出数据包的源端口并进行端口转换，即端口地址转换(PAT, Port Address Translation)。采用端口多路复用方式。内部网络的所有主机均可共享一个合法外部 IP 地址实现对 Internet 的访问，从而可以最大限度地节约 IP 地址资源。同时，又可隐藏网络内部的所有主机，有效避免来自 Internet 的攻击。因此，目前网络中应用最多的就是端口多路复用方式。

## 1 NAT 原理
### 1.1 NAT 路由器
家庭网络可以是都由私有地址而组成的专用网络，这种地址进对网络中的设备有意义的网络，可以称之为具有专用地址的地域。由于现在存在着数十万家庭网络，有很多的设备都在使用私有地址，而此时当全球因特网进行收发分组时，私有地址的编址问题应该如何解决？NAT 技术就可以化解这个难题，接下来我们来谈一下 NAT 技术原理。
装有 NAT 软件的路由器叫做 NAT 路由器，NAT 路由器具有一个接口，连接一个具有相同网络前缀的网络。NAT 能够使得路由器对于外界而言不像是一个路由器，而是使得 NAT 路由器对外界的行为就像是一个具有单一 IP 地址的单一设备，从本质上讲 NAT 使得路由器对外界隐藏了家庭网络的细节。也就是说对于外界而言，发给一个家庭网络的所有数据报都会被 NAT 路由器接收进来。

<img src ="https://img-blog.csdnimg.cn/0103231d61c44fd7ac1269bd4e126b26.png#pic_center" width = 48%>


### 1.2 NAT 转换表
接下来考虑，从广域网到达 NAT 路由器的所有数据报的目的 IP 地址，应该都是 NAT 路由器的 IP 地址，NAT 路由器要如何得知某个分组应该发送给那个内部主机呢？解决方案就是 NAT 转换表，在表中包含了端口号和对应的 IP 地址。
NAT 转换表在一次工作中的变化为：内部主机 A 用本地地址 IPa 和互联网上主机 B 通信所发送的数据报必须经过 NAT 路由器。NAT 路由器将数据报的源地址 IPa 转换成全球地址 IPg，并把转换结果记录到 NAT 地址转换表中，目的地址 IPb 保持不变，然后发送到互联网。NAT 路由器收到主机 B 发回的数据报时，知道数据报中的源地址是 IPb 而目的地址是 IPg。根据 NAT 转换表，NAT 路由器将目的地址 IPG 转换为 IPA，转发给最终的内部主机 A。 也就是说在一次内部主机与外部主机通信时，在 NAT 路由器上发生了两次地址转换：离开专用网时，替换源地址，将内部地址替换为全球地址；进入专用网时，替换目的地址，将全球地址替换为内部地址。

<img src ="https://img-blog.csdnimg.cn/9444236a7c524b818311110ef8120dc1.png#pic_center" width = 48%>

由此可见，通过 NAT 路由器的通信必须由专用网络内的主机发起，否则 NAT 路由器无法完成转换工作。专用网络内部的主机也不能充当服务器，因为互联网上的客户无法请求专用网内的服务器提供服务。


### 1.3 NAPT
为了更加有效地利用 NAT 路由器上的全球 IP 地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。使用端口号的 NAT 叫做网络地址与端口号转换 NAPT，不过这与 NAT 的原理是一样的，并没有本质上的区别。
NAPT 把专用网内不同的源 IP 地址，都转换为同样的全球 IP 地址。但对源主机所采用的 TCP 端口号（不管相同或不同），则转换为不同的新的端口号。因此当 NAPT 路由器收到从互联网发来的应答时，就可以从 IP 数据报的数据部分找出运输层的端口号，然后根据不同的目的端口号，从 NAPT 转换表中找到正确的目的主机。

<img src ="https://img-blog.csdnimg.cn/9321ed71fb6841b195d81c8d8bfd3c7f.png#pic_center" width = 48%>


### 1.4 NAT 引发的争议

NAT 在得到广泛应用的同时，也存在着很多争议，主要包括以下 4 点：
1. 路由器应该仅针对网络层，仅负责完成网络层的功能，转发网络层的分组；
2. NAT 违背了端到端通信的原则，存在 NAT 路由器作为中继；
3. 端口号应该是用于进程寻址，而不是应用于主机寻址；
4. IPv4 地址不足的问题完全可以使用 IPv6 来解决。


### 1.5 与 DHCP 协议的关系

当我们讨论完 NAT 技术，现在我们回到一开头想一想，家庭网络计算机从哪儿得到地址？NAT 路由器是如何得到单一的全球地址呢？答案就是我们之前讨论过的 DHCP 协议，路由器将从 ISP 的 DHCP 服务器得到它的地址，并且路由器运行一个 DHCP 服务器，为位于 NAT-DHCP 路由器控制的家庭网络地址空间中的计算机提供地址。

<img src ="https://img-blog.csdnimg.cn/75826742148d4d4ca9b87f3207b87a28.png#pic_center" width = 48%>















