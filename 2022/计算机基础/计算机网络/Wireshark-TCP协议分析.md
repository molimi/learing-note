TCP（Transmission Control Protocol 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，提供可靠交付的服务和全双工通信。每一条 TCP 连接只能有两个端点，在简化的计算机网络 OSI 模型中，它完成第四层传输层所指定的功能。用户数据报协议（UDP）是同一层内另一个重要的传输协议。在因特网协议族（Internet Protocol Suite）中，TCP 层是位于 IP 层之上，应用层之下的中间层。不同主机的应用层之间经常需要可靠的、像管道一样的连接，但是 IP 层不提供这样的流机制，而是提供不可靠的包交换。

可靠传输的工作原理：
理想的传输条件有以下两个特点：
(1) 传输信道不产生差错；
(2) 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据。

在这样的理想传输条件下，不需要采取任何措施就能够实现可靠传输。但实际网络不具备以上两个理想条件，但我们可以使用一些可靠传输协议。当出现差错时让发送方重传出现差错的数据，同时在接收方来不及处理收到的数据时，及时告诉发送方适当降低发送数据的速度。这样本来不可靠的传输信道就能够实现可靠传输。

而常用的协议就有以下两种：
(1) 停止等待协议；
(2) 连续 ARQ 协议。

TCP 报文段：
TCP 虽然是面向字节流的，但 TCP 传送的数据单元却是报文段，如图 1 所示：

## 1 TCP 协议

TCP 首部格式如下：

<img src ="https://img-blog.csdnimg.cn/0cfa297c63924635b88b335c6b37a953.png#pic_center" width = 48%>


**字段解析**
- 源端口、目的端口：各占 2 字节，端口是运输层与应用层的服务接口，运输层的复用和分用功能都要通过端口才能实现。
- 序列号：占 4 字节，TCP 连接中传送的数据流中的每一个字节都编上一个序号，序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。
- 确认号：占 4 字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。
- 首部长度：占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远，的单位是 32 位字（以 4 字节为计算单位）。
- 保留：占 6 位，保留为今后使用，但目前应置为 0。
- 接收窗口：占 2 字节，用于流量控制，指示接收方愿意接收的字节数量，单位为字节。
- 检验和：占 2 字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。
- 选项：长度可变。TCP 最初只规定了最大报文段长度 MSS，表示缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节。

**标志字段**
- 紧急 URG：当 URG = 1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。
- 确认 ACK：只有当 ACK = 1 时确认号字段有效，当 ACK = 0 时确认号无效。
- 推送 PSH(PuSH)：接收 TCP 收到 PSH = 1 的报文段，就尽快地交付接收应用进程，不再等到整个缓存都填满了后再向上交付。
- 复位 RST(ReSeT)：当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因）必须释放连接，然后再重新建立运输连接。
- 同步 SYN：同步 SYN = 1 表示这是一个连接请求或连接接受报文。
- 终止 FIN(FINish)：用来释放一个连接。FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。


**捕获从计算机到远程服务器的批量 TCP 传输**

我们需要使用 Wireshark 来获取文件从计算机到远程服务器的 TCP 传输的数据包内容。首先访问一个网页，在网页上输入计算机上存储的文件名（包含 Alice in Wonderland 的 ASCII 文本），然后使用 HTTP POST 方法将文件传输到 Web 服务器（不使用 GET 方法的原因是我们希望大量数据从您的计算机传输到另一台计算机）。而在此同时，要运行 Wireshark 以获取从您的计算机发送和接收的 TCP 区段的内容。

1. 打开浏览器，在 `http://gaia.cs.umass.edu/wireshark-labs/alice.txt` 查看 Alice in Wonderland 的 ASCII 档案文件，将其保存；
2. 浏览 `http://gaia.cs.umass.edu/wireshark-labs/TCP-wireshark-file1.html`，能得到以下内容；

<img src ="https://img-blog.csdnimg.cn/09efab86c34f49b1ae82db802a3f26db.png#pic_center" width = 48%>

3. 在此表单的"Browse..."按钮在计算机上输入包含 Alice in Wonderland 的文件名（完整路径名）。这时不用按下"Upload alice.txt file"按钮；
4. 启动 Wireshark ，开始捕获，在 Wireshark 数据包捕获选项视窗上按 OK；
5. 返回浏览器，按"Upload alice.txt file"将按钮文件上传到 gaia.cs.umass.edu 服务器。文件上传后，浏览器窗口显示一条简短的祝贺消息；
6. 停止 Wireshark 数据包捕获，Wireshark 显示内容。

<img src ="https://img-blog.csdnimg.cn/82698d503ede4d56a9ddb986ef2d6030.png#pic_center" width = 48%>

抓包软件中的 TCP 分析

<img src ="https://img-blog.csdnimg.cn/c4878f2e0c894f2eb353de22393e5e8e.png#pic_center" width = 48%>

展开 Flags 的头，得到的信息如下：

<img src ="https://img-blog.csdnimg.cn/3f59348c1bfc427d8cfc218e6ebc4d11.png#pic_center" width = 48%>


由此我们可以得到具体的 TCP 报文信息。




